# Решение для финала олимпиады TrueTechChamp от МТС 2023
https://truetechchamp.ru/

# Описание задачи:

Эмулируется приложение запущенное в облачной инфраструктуре на виртуальных машинах. Приложение использует базу данных, развернутую на отдельной виртуальной машине. Участники должны оптимизировать расходы на инфраструктуру с наименьшими простоями в работе приложения.

Описание работы эмуляции – участникам не известно. Все числа приведены для примера. Основной параметр, определяющий нагрузку на приложение – количество входящих запросов. Количество входящих запросов изменяется в течении дня от 0 до нескольких тысяч по определенному закону. 

На обработку каждого запроса требуются ресурсы приложения и ресурсы базы данных.

Время обработки запроса складывается из времени обработки в приложении и времени выполнения запроса в БД.

При выполнении запроса больше 400ms он считается неуспешным 

Для работы приложения необходимо иметь как минимум одну виртуальную машину и одну виртуальную машину с базой данных.

## Ресурсы приложения

Выполнение каждого запроса требует 0.001 CPU и 5Mb памяти

Время выполнения запроса – 50ms 

Накладные расходы приложения на каждой виртуальной машине – 0.05 CPU, 300Mb памяти

Если суммарное количество требуемых ресурсов CPU превышает 95% от выделенных, то приложение перестает отвечать и уходит в оффлайн

Если суммарное количество требуемых ресурсов памяти превышает 95% от выделенной, то приложение перестает отвечать и уходит в оффлайн

### Ресурсы БД

Выполнение каждого запроса требует 0.001 CPU и 30Mb памяти

Время выполнения запроса – 50ms 

Накладные расходы ядра БД на каждой машине с БД – 0.05 CPU, 512Mb памяти

Если суммарное количество требуемых ресурсов CPU превышает превышает 95% от выделенных, то приложение перестает отвечать и уходит в оффлайн

Если суммарное количество требуемых ресурсов памяти превышает 95% от выделенной, то приложение перестает отвечать и уходит в оффлайн

### Общие принципы работы с виртуальными машинами

При изменении количества ресурсов виртуальной машины - виртуальная машина перестает работать на 3 минуты. Тарификация машины продолжается

При заказе новой виртуальной машины - она становится доступной через 5 минут . Но тарификация начинается с момента создания машины

### Время ответа приложения

Время ответа приложения зависит от нагрузки на CPU для виртуальных машин и базы данных. Виртуальные машины и базы данных вносят разные задержки в обработку запроса. Если время ответа на запрос превышает 400мс, то приложение уходит в оффлайн.

## API

###  Запрос ресурсов

Возвращается список из

* тип ресурса - db/vm
* стоимость ресурса (cost)
* нагрузка на cpu
* нагрузка на память
* количество cpu
* количество памяти
* ID ресурса
* состояние неработоспособности ресурса (failed) после заказа или изменения

### Запрос цен

Возвращается список ценовых позиций из

* тип ресурса vm/db
* стоимость ресурса
* количество cpu
* количество ram
* ID позиции

### Запрос текущей статистики

Возвращает текущую статистику по пользователю, запрос включает:

* "availability": доступность сервиса по шкале 0…1. 1 означает работу сервиса 100% времени без пропущенных запросов
* "cost_total": общие затраты накопительным итогом
* "db_cpu": всего цпу для баз данных
* "db_cpu_load": текущая нагрузка на цпу базы данных. 
* "db_ram": всего памяти для базы данных
* "db_ram_load": текущая нагрузка на память базы данных
* "last1": затраты за последнюю минуту
* "last15": затраты за последние 15 минут
* "last5": затраты за последние 5 минут
* "lastDay": затраты за последний день
* "lastHour": затраты за последний час
* "lastWeek": затраты за последнюю неделю
* "offline_time": общее время оффлайна
* "online": признак работоспособности
* "online_time": общее время онлайна
* "requests": текущее количество запросов
* "requests_total": общее количество запросов, поступившее к приложению
* "response_time": время ответа приложения (должно быть меньше 400 для работоспособного приложения)
* "vm_cpu": всего цпу для виртуальных машин
* "vm_cpu_load": нагрузка на цпу для виртуальных машин
* "vm_ram": всего памяти для виртуальных машин
* "vm_ram_load": нагрузка на память для виртуальных машин

Все запросы к API (кроме получения списка цен) делаются с токеном пользователя. 

Токен пользователя можно найти в правой части страницы, под доступами к gitlab.

Заказ/модификация ресурса возможны только в комбинациях CPU/RAM для которых есть соответствующая строка с ценами.

Ссылка на полную документацию API: https://mts-olimp-cloud.codenrock.com/api/ui/
## Оценка работы сервиса

Мы собираем 2 показателя, которые оценивают эффективность решения: количество затрачиваемых ресурсов и кол-во минут, которые "сервис" был оффлайн.

Расчет со стороны API происходит каждую минуту: каждый "тик" времени сервис записывает в лидерборд кол-во потраченных за эту минуту "ресурсов" (число) и время, которое сервис был оффлайн (0 или 1). Лидерборд складывает эти данные и показывает итоговые числа по работе системы.

Для исключения разности результатов ввиду разного времени старта работы сервиса, итоговый лидерборд будет строиться отдельно.
После завершения работы над решением (стоп-кодинг), мы отключим возможность обновлять алгоритмы, сбросим лидерборд и в течении 60 минут "засечем" работу всех решений с нуля. Таким образом, сформировав итоговый лидерборд по этапу, на основании которого и будут выявлены лидеры.